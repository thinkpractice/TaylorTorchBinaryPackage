name: Build SwiftPM artifactbundles

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux-x86_64-cpu
            os: ubuntu-latest
            compute: cpu
            triple: x86_64-unknown-linux-gnu
            libtorch: "2.9.1"
          - name: macos-arm64-cpu
            os: macos-14
            compute: macos-arm64
            triple: arm64-apple-macosx
            libtorch: "2.9.1"

    env:
      LIB_TORCH_COMPUTE_PLATFORM: ${{ matrix.compute }}
      SWIFT_VERSION: swift-DEVELOPMENT-SNAPSHOT-2025-11-03

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure build tools
        if: startsWith(matrix.os, 'macos')
        run: |
          brew install cmake wget curl || true

      - name: Ensure build tools (Linux)
        if: startsWith(matrix.os, 'ubuntu')
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake wget curl libcurl4-openssl-dev

      - name: Cache Swift toolchain (macOS)
        if: startsWith(matrix.os, 'macos')
        id: cache-swift-macos
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Toolchains/${{ env.SWIFT_VERSION }}-a.xctoolchain
          key: swift-toolchain-${{ matrix.os }}-${{ env.SWIFT_VERSION }}

      - name: Cache Swift toolchain (Linux)
        if: startsWith(matrix.os, 'ubuntu')
        id: cache-swift-linux
        uses: actions/cache@v4
        with:
          path: |
            ~/.swiftly/toolchains
          key: swift-toolchain-${{ matrix.os }}-${{ env.SWIFT_VERSION }}

      - name: Install Swift via Swiftly (macOS)
        if: startsWith(matrix.os, 'macos') && steps.cache-swift-macos.outputs.cache-hit != 'true'
        run: |
          export PATH="$(brew --prefix gnu-getopt)/bin:$PATH"
          curl -O https://download.swift.org/swiftly/darwin/swiftly.pkg
          installer -pkg swiftly.pkg -target CurrentUserHomeDirectory
          ~/.swiftly/bin/swiftly init --quiet-shell-followup
          . "${SWIFTLY_HOME_DIR:-$HOME/.swiftly}/env.sh"
          hash -r
          swiftly install ${SWIFT_VERSION} --assume-yes --use
          . "${SWIFTLY_HOME_DIR:-$HOME/.swiftly}/env.sh"
          hash -r
          rm swiftly.pkg
          echo "✅ Swift ${SWIFT_VERSION} installed successfully"
          swift --version


      - name: Install Swift via Swiftly (Linux)
        if: startsWith(matrix.os, 'ubuntu') && steps.cache-swift-linux.outputs.cache-hit != 'true'
        run: |
          curl -O https://download.swift.org/swiftly/linux/swiftly-$(uname -m).tar.gz
          tar zxf swiftly-$(uname -m).tar.gz
          yes | ./swiftly init --quiet-shell-followup --skip-install
          . "${SWIFTLY_HOME_DIR:-$HOME/.local/share/swiftly}/env.sh"
          hash -r
          swiftly install ${SWIFT_VERSION} --assume-yes --use
          . "${SWIFTLY_HOME_DIR:-$HOME/.local/share/swiftly}/env.sh"
          hash -r
          echo "✅ Swift ${SWIFT_VERSION} installed successfully"
          swift --version
      - name: Set Swift toolchain env
        if: startsWith(matrix.os, 'macos') || startsWith(matrix.os, 'ubuntu')
        run: |
          if [[ "${{ matrix.os }}" == macos* ]]; then
            . "${SWIFTLY_HOME_DIR:-$HOME/.swiftly}/env.sh"
          else
            . "${SWIFTLY_HOME_DIR:-$HOME/.local/share/swiftly}/env.sh"
          fi
          hash -r
          SWIFT_TOOLCHAIN_PATH="$(swiftly use --print-location)"
          SWIFT_TOOLCHAIN_DIR="${SWIFT_TOOLCHAIN_PATH}/usr"
          {
            echo "SWIFT_TOOLCHAIN_PATH=${SWIFT_TOOLCHAIN_PATH}"
            echo "SWIFT_TOOLCHAIN_DIR=${SWIFT_TOOLCHAIN_DIR}"
            echo "CC=${SWIFT_TOOLCHAIN_DIR}/bin/clang"
            echo "CXX=${SWIFT_TOOLCHAIN_DIR}/bin/clang++"
            echo "SWIFT_TOOLCHAIN=${SWIFT_TOOLCHAIN_PATH}"
            echo "SWIFT_BRIDGING_INCLUDE_DIR=${SWIFT_TOOLCHAIN_PATH}/usr/include"
            echo "SWIFT_BIN_DIR=${SWIFT_TOOLCHAIN_DIR}/bin"
          } >> "${GITHUB_ENV}"

      - name: Fetch libtorch
        run: |
          bash ./get-pre-build-torch.sh --version "${{ matrix.libtorch }}" --platform "${LIB_TORCH_COMPUTE_PLATFORM}" --output .

      - name: Configure
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DLIBTORCH_ROOT="$PWD/libtorch"

      - name: Build artifactbundle zip
        run: |
          cmake --build build --target package-swift-zip --config Release

      - name: Collect artifacts and checksums
        run: |
          ART_DIR="$PWD/artifacts/${{ matrix.triple }}-${{ matrix.compute }}-v${{ matrix.libtorch }}"
          mkdir -p "${ART_DIR}"
          cp build/artifactbundle/ATenCXX.artifactbundle.zip "${ART_DIR}/ATenCXX.artifactbundle.zip"
          swift package compute-checksum "${ART_DIR}/ATenCXX.artifactbundle.zip" > "${ART_DIR}/ATenCXX.artifactbundle.zip.checksum"
          cat "${ART_DIR}/ATenCXX.artifactbundle.zip.checksum"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ATenCXX-${{ matrix.triple }}-${{ matrix.compute }}-v${{ matrix.libtorch }}
          path: artifacts/${{ matrix.triple }}-${{ matrix.compute }}-v${{ matrix.libtorch }}/ATenCXX.artifactbundle.zip*

      - name: Upload to GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/${{ matrix.triple }}-${{ matrix.compute }}-v${{ matrix.libtorch }}/ATenCXX.artifactbundle.zip
            artifacts/${{ matrix.triple }}-${{ matrix.compute }}-v${{ matrix.libtorch }}/ATenCXX.artifactbundle.zip.checksum
